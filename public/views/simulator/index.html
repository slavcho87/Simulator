<div ng-init="getSceneList()">    
        <div id="wrapper" >
            <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="#/" ng-click="exit()">Simulator</a>
                </div>

                <div class="collapse navbar-collapse navbar-ex1-collapse">
                    <ul class="nav navbar-nav side-nav">
                        <li><a href="#/map"onclick="stopMoveDynamicItems()"><i class="fa fa-map-marker"></i> Maps</a></li>
                        <li class="active"><a href="#/simulator"><i class="fa fa-globe"></i> Simulation</a></li>
                        <li><a href="#/settings"><i class="fa fa-cog"></i> Settings</a></li>
                        <li><a href="#/profile"><i class="fa fa-edit"></i> Profile</a></li>
                        <li><a href="#/" ng-click="exit()"><i class="fa fa-power-off"></i> Exit</a></li>
                    </ul>
                </div>
            </nav>
            
            <div id="page-wrapper" ng-show="sceneList.length>0">
                <div class="alert alert-dismissable alert-danger" ng-repeat="errorMsg in errorMsgList">
                    <button type="button" 
                            class="close" 
                            data-dismiss="alert" 
                            aria-hidden="true" 
                            ng-click="msgHide(errorMsg)">&times;</button>
                    {{errorMsg}}
                </div>   
                
                <div class="row">
                    <div class="col-sm-4">
                        <label>Select scene: </label>
                         <select ng-model="selectedScene" class="form-control">
                            <option ng-repeat="sceneValue in sceneList" value="{{sceneValue}}">{{sceneValue.sceneName}}</option>
                         </select>
                    </div>
                    
                    <div class="col-sm-4">
                        </br>
                        <button type="button" class="btn btn-primary" ng-click="loadData()">Load scene</button>
                    </div>
                </div>
            </div>
    
            <div id="page-wrapper" ng-show="sceneListEmpty">
                <div class="row">
                    <div class="col-sm-4">
                        <p>This map has no scenes</p>
                    </div>
                </div>
            </div>
    
            
            <div id="page-wrapper" ng-hide="hideLoadBar">
                {{info}}
                <div class="progress progress-striped active">
                    <div class="progress-bar" role="progressbar"
                         aria-valuemin="0" aria-valuemax="100"
                         style="width: 90%">
                        <span class="sr-only">45% completado</span>
                    </div>
                </div>
            </div>
            
            <div id="page-wrapper" ng-show="simulationDataLoaded">		                
                <div class="row">    
                    <div id="mapa" class="mapa col-sm-8">
                    </div>
                        <script src="javascripts/socketsIO/socket.io.js"></script>
                        <script type="text/javascript">
                            var socket = io();
                            var dirMove;
                            var appElement = document.querySelector('[ng-app=app]');
                            var $scope = angular.element(appElement).scope();
                            $scope = $scope.$$childHead; 
                            var mapCenter = $scope.mapCenter;
                            var cont = 0;
                            var date = new Date();
                            var userMoveRefreshInterval = 1000;
                            var userMoveTemporizador;
                            var dynamicItemMoveTemporizador;
                            var userTimeStamp;
                            var dynamicItemRefreshInterval = 100;
                            var artists = [];
                            
                            socket.on('recommended items', function(data){
                                var appElement = document.querySelector('[ng-app=app]');
                                var $scope = angular.element(appElement).scope();
                                $scope = $scope.$$childHead;
                               
                                var index = data.userList.indexOf($scope.token);
                                if(index>=0){
                                    $scope.$apply(function(){
                                        $scope.recommendedItemList = data.itemList;
                                    });    
                                }
                            });
                            
                            socket.on('user change position', function(data){
                                setUser(data.user, data.pos, data.id);
                            });
                            
                            socket.on('start-pause', function(data){
                                if(data.state == 'start'){
                                    startMoveDynamicItems('event'); 
                                }else{
                                    stopMoveDynamicItems('event');
                                }
                            });
                            
                            function userMove(){
                                if(date != new Date()){
                                    switch(dirMove){
                                    case "up":
                                            //mas long
                                            moveUp();
                                            break;
                                    case "down":
                                            //menos long
                                            moveDown();
                                            break;
                                    case "left":
                                            //menos lat
                                            moveLeft();
                                            break;
                                    case "right":
                                            //mas lat
                                            moveRight();
                                            break;
                                    }
                                }
                                date = new Date();
                            }
                            
                            function moveUp(){
                                var pos = overlayList['user'].getPosition();
                                pos = ol.proj.transform(pos, 'EPSG:3857', 'EPSG:4326');
                                pos = getNewPos(pos, distance($("#userSpeed").val(), userMoveRefreshInterval), 90);
                                setUserPos(pos);
                                var data = {
                                    user: getImg(),
                                    pos: pos,
                                    id: getUser()._id
                                };
                                socket.emit('user change position', data);
                            }
                            
                            function moveDown(){
                                var pos = overlayList['user'].getPosition();
                                pos = ol.proj.transform(pos, 'EPSG:3857', 'EPSG:4326');
                                pos = getNewPos(pos, distance($("#userSpeed").val(), userMoveRefreshInterval), 270);
                                setUserPos(pos);
                                var data = {
                                    user: getImg(),
                                    pos: pos,
                                    id: getUser()._id
                                };
                                socket.emit('user change position', data);
                            }
                            
                            function moveLeft(){
                                var pos = overlayList['user'].getPosition();
                                pos = ol.proj.transform(pos, 'EPSG:3857', 'EPSG:4326');
                                pos = getNewPos(pos, distance($("#userSpeed").val(), userMoveRefreshInterval), 180);
                                setUserPos(pos);
                                var data = {
                                    user: getImg(),
                                    pos: pos,
                                    id: getUser()._id
                                };
                                socket.emit('user change position', data);
                            }
                            
                            function moveRight(){
                                var pos = overlayList['user'].getPosition();
                                pos = ol.proj.transform(pos, 'EPSG:3857', 'EPSG:4326');
                                pos = getNewPos(pos, distance($("#userSpeed").val(), userMoveRefreshInterval), 0);
                                setUserPos(pos);
                                var data = {
                                    user: getImg(),
                                    pos: pos,
                                    id: getUser()._id
                                };
                                socket.emit('user change position', data);
                            }
                            
                            function toRad(num) {
                               return num * Math.PI / 180;
                            }
                            
                            function toGrad(radianes){
                                return radianes*180/Math.PI;
                            }
                            
                            /* Dada la posicion actual, la distancia a recorrer y el rumbo devuelve las coordenadas geograficas del punto
                            donde hay que moverse*/
                            function getNewPos(pos, d, brng){
                                var R = 6378000;//radio de la tierra
                                var φ1 = toRad(pos[0]);
                                var λ1 = toRad(pos[1]);
                                
                                var φ2 = Math.asin(Math.sin(φ1)*Math.cos(d/R)+Math.cos(φ1)*Math.sin(d/R)*Math.cos(toRad(brng)));
                                var λ2 = λ1 + Math.atan2(Math.sin(toRad(brng))*Math.sin(d/R)*Math.cos(φ1),
                                                         Math.cos(d/R)-Math.sin(φ1)*Math.sin(φ2));
                                
                                var newPos = [toGrad(φ2), toGrad(λ2)];
                                return newPos;
                            }
                            
                            function setUserPos(newPos){
                                var index = map.getOverlays().getArray().indexOf(overlayList['user']);
                                
                                if(index>=0){
                                    map.getOverlays().getArray()[index].setPosition(ol.proj.transform(newPos, 'EPSG:4326', 'EPSG:3857'));
                                }
                            }
                            
                            function setUser(img, newPos, id){ 
                                if(overlayList[id]){
                                    map.removeOverlay(overlayList[id]);                                
                                }
                                
                                var user = new ol.Overlay({
                                    position: ol.proj.transform(newPos, 'EPSG:4326', 'EPSG:3857'),
                                    element: $('<img src="'+img+'" class="img-circle" name="'+id+'">')
                                    .css({marginTop: '-50%', marginLeft: '-50%', width: '40px', height: '40px', cursor: 'pointer'})
                                });
                                
                                overlayList[id] = user;
                                
                                map.addOverlay(user);
                            }
                            
                            function getUser(){
                                var index = map.getOverlays().getArray().indexOf(overlayList['user']);
                                return map.getOverlays().getArray()[index];
                            }
                            
                            var overlayList = {};
                            
                            var map = new ol.Map({
                                target: 'mapa',
                                layers: [
                                    new ol.layer.Tile({
                                        source: new ol.source.MapQuest({layer: 'osm'})
                                    })
                                ],
                                controls: ol.control.defaults().extend([
                                    new ol.control.FullScreen()
                                ])
                            });
                    
                            map.on('singleclick', function(evt) { 
                                if(overlayList['user']){
                                    map.removeOverlay(overlayList['user']);                                
                                }
                                
                                overlayList['user'] = new ol.Overlay({
                                    position: evt.coordinate,
                                    element: $('<img src="'+getImg()+'" class="img-circle" name="'+getUser()._id+'">')
                                    .css({marginTop: '-50%', marginLeft: '-50%', width: '40px', height: '40px', cursor: 'pointer'})
                                });
                                                               
                                map.addOverlay(overlayList['user']);
                                
                                if(!userMoveTemporizador){
                                    userMoveTemporizador = window.setInterval('userMove()',userMoveRefreshInterval);
                                }
                                
                                var data = {
                                    user: getImg(),
                                    pos: ol.proj.transform(evt.coordinate, 'EPSG:3857', 'EPSG:4326'),
                                    id: getUser()._id
                                };
                                socket.emit('user change position', data);
                            });      
                            
                            $(document).keypress(function(e)
                            { 
                                if(e.timeStamp != userTimeStamp){
                                    if(window.location.hash=="#/simulator"){
                                            switch(e.which){
                                                case 119: //es la w. Significa arriba
                                                    up(); 
                                                    break;
                                                case 115: //es la s. Significa abajo
                                                    down(); 
                                                    break;  
                                                case 97: //es la a. Significa izq  
                                                    left(); 
                                                    break; 
                                                case 100: //es la d. Signfica dcha
                                                    right(); 
                                                    break;
                                                case 32:  //es la barra de espacio
                                                    startStopUser(e);
                                                    break;
                                            }
                                    }
                                }
                                
                                userTimeStamp = e.timeStamp;
                            });
                            
                            function up(){
                                dirMove = "up";
                            }
                            
                            function down(){
                                dirMove = "down";
                            }
                            
                            function left(){
                                dirMove = "left";
                            }
                            
                            function right(){
                                dirMove = "right";
                            }
                            
                            function startStopUser(e){
                                if(userMoveTemporizador){
                                    userMoveTemporizador= window.clearInterval(userMoveTemporizador);
                                }else{
                                    userMoveTemporizador = window.setInterval('userMove()',userMoveRefreshInterval);
                                }
                            }
                            
                            function getImg(){
                                return getScope().userImg;
                            }
                            
                            function getUser(){
                                return getScope().getUser();
                            }
                            
                            function getScope(){
                                var appElement = document.querySelector('[ng-app=app]');
                                var $scope = angular.element(appElement).scope();
                                return $scope.$$childHead;
                            }
                            
                            /* Recibe el tiempo de ms y lo pasa en segundos */
                            function getTiemeInSecunds(time){
                                return (time/1000);
                            }
                            
                            /* Distancia recorrida por el usuario dado el tiempo de refresco */
                            function distance(vel, time){
                                var oneKm = 1000;
                                var oneHour = 3600;
                                var factor = oneKm/oneHour;
                                
                                var userVel = factor*vel;
                                return (userVel*getTiemeInSecunds(time));
                            }
                            
                            /* Distancia en metros entre dos punto geograficos */
                            function distanceBetween(lon1, lat1, lon2, lat2){
                                var R = 6357000;
                                var difLat = lat2 - lat1;
                                var difLon = lon2 - lon1;
                                var a = (Math.sin(difLat/2)*Math.sin(difLat/2))+
                                    Math.cos(lat1)*Math.cos(lat2)*Math.sin(difLon/2)*Math.sin(difLon/2);
                                var c = 2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                                return R*c;
                            }
                            
                            function ItemsMove(){
                                var list = $scope.dynamiItemsList;
                                
                                for(index in list){
                                    var overlay = list[index].overlay;
                                    var i = artists[index];
                        
                                    var lon2 = toRad(parseFloat(list[index].route[i+1].routeId.longitude));
                                    var lat2 = toRad(parseFloat(list[index].route[i+1].routeId.latitude));
                                    
                                    //calculamos la distancia entre el punto actual y el final
                                    var pos = ol.proj.transform(overlay.getPosition(), 'EPSG:3857', 'EPSG:4326'); 
                                   
                                    var disAct = distanceBetween(toRad(pos[1]), toRad(pos[0]), lon2, lat2);
                                    
                                    //calculamos la distancia a recorrer
                                    var disToRec = distance(list[0].speed, dynamicItemRefreshInterval);
                                    
                                    var newPos;
                                    var difDist = disAct - disToRec; 
                                    
                                    if(disToRec < disAct){
                                        newPos = getNewPos(pos, distance(list[index].speed, dynamicItemRefreshInterval),
                                                       list[index].course[i]);
                                    }else{
                                        newPos = [parseFloat(list[index].route[i+1].routeId.latitude), 
                                                 parseFloat(list[index].route[i+1].routeId.longitude)];
                                        
                                        artists[index] = artists[index]+1;
                                    }
                                    
                                    map.removeOverlay(overlay);

                                    list[index].overlay = new ol.Overlay({
                                        position: ol.proj.transform(newPos, 'EPSG:4326', 'EPSG:3857'),
                                        element: overlay.getElement()
                                    }); 

                                    map.addOverlay(list[index].overlay);   
                                }
                            }
                            
                            function startMoveDynamicItems(event){
                                if(artists.length == 0){
                                    for(index in $scope.dynamiItemsList){
                                        artists[index] = 0;
                                    }
                                }
                                
                                dynamicItemMoveTemporizador = window.setInterval('ItemsMove()', dynamicItemRefreshInterval);
                                $scope.$apply(function(){
                                    $scope.showPlay = false;
                                });
                                
                                if(event != 'event'){
                                    var data = {
                                        state: 'start',
                                        user: getUser()._id        
                                    };
                                    socket.emit('start-pause', data);    
                                }
                            }              
                            
                            function stopMoveDynamicItems(event){
                                dynamicItemMoveTemporizador = window.clearInterval(dynamicItemMoveTemporizador);
                                $scope.$apply(function(){
                                    $scope.showPlay = true;
                                });
                                
                                if(event != 'event'){
                                    var data = {
                                        state: 'stop',                                    
                                        user: getUser()._id        
                                    };
                                    socket.emit('start-pause', data);
                                }
                            }
                            
                            function setRating(itemId){
                                var rating = $('#'+itemId).val();
                                if(rating>0){
                                    $scope.setRating(itemId, rating);    
                                }
                            }
                        </script>
                    
                    <div class="col-sm-4">
                        <button type="button" ng-show="showPlay" class="btn btn-default fa fa-play-circle-o" onclick="startMoveDynamicItems()">
                        </button>
                        
                        <button type="button" ng-hide="showPlay" class="btn btn-default fa fa-pause" onclick="stopMoveDynamicItems()">
                        </button>
                        
                        <button type="button" class="btn btn-default fa fa-download">                         
                        </button>
                            
                        <button type="button" class="btn btn-default fa fa-arrow-up" onclick="up()">                         
                        </button>

                        <button type="button" class="btn btn-default fa fa-arrow-down" hidden="hidden" onclick="down()">                         
                        </button>
                        
                        <button type="button" class="btn btn-default fa fa-arrow-left" onclick="left()">                         
                        </button>
                 
                        <button type="button" class="btn btn-default fa fa-arrow-right" onclick="right()">                         
                        </button>
                          
                        <table class="table">
                            <tbody>
                                <tr ng-repeat="item in recommendedItemList">
                                    <th scope="row">{{$index+1}}</th>
                                    <td>{{item.itemName}}</td>
                                    <td>
                                        <select ng-change="setRating(item.id, rating)" ng-model="rating">
                                            <option value="1">1</option>
                                            <option value="2">2</option>
                                            <option value="3">3</option>
                                            <option value="4">4</option>
                                            <option value="5">5</option>
                                        </select>
                                    </td>
                                </tr>
                            </tbody>
                        </table>    
                       
                        <div class="row">
                            <div class="">
                                <div class="col-xs-6">
                                    <label>User speed (km/h)</label>
                                    <input id="userSpeed" class="form-control" value="5"/>
                                </div>
                                
                                <div class="col-xs-12">
                                    <br/>
                                    <label>Result type show</label>
                                    <select class="form-control" ng-model="resultTypeShow">
                                        <option value="emptyList">Show empty list if not relevant items found</option>
                                        <option value="nonPersonalizedRecommendation">Show non-personalized recommendation if not relevant items found</option>
                                    </select>
                                </div>
                                
                                <div class="col-xs-12">
                                    <br/>
                                    <label>Item types to recommend</label>
                                    <br/>
                                    
                                    <span ng-repeat="itemType in itemTypeList">
                                        <input type="checkbox" 
                                           checklist-model="itemTypesToRecommend" checklist-value="itemType._id">{{itemType.name}}  
                                    </span>
                                    
                                    <br><br>
                                    <input type="submit" ng-click="recomend()" class="btn btn-primary" value="Recommend items">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>							
            </div>            
        </div>
    </div>